@using Nop.Core.Domain.LogisticsQuotes
@model LogisticsQuoteModel

<div class="card-body carrier-information">

	<div class="row">
		<div class="col-md-6">
			<div class="card h-100">
				<div class="card-body">
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="CompanyId" asp-required="true" />
						</div>
						<div class="input-name">
							<nop-select class="form-select" asp-for="CompanyId" asp-items="Model.AvailableCompanies" />
							<span asp-validation-for="CompanyId"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="CustomerId" asp-required="Model.LogisticsQuoteCustomerIdRequired" />
						</div>
						<div class="input-name">
							<nop-select class="form-select" asp-for="CustomerId" asp-items="Model.AvailableCustomers" />
							<span asp-validation-for="CustomerId"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="Phone1" asp-required="Model.LogisticsQuotePhone1Required" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="Phone1" />
							<span asp-validation-for="Phone1"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="Email" asp-required="Model.LogisticsQuoteEmailRequired" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="Email" html-attributes="@(new { placeholder = "Enter Email" })" />
							<span asp-validation-for="Email"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="ReferredBy" asp-required="Model.LogisticsQuoteReferredByRequired" />
						</div>
						<div class="input-name">
							<nop-select class="form-select" asp-for="ReferredBy" asp-items="Model.AvailableReferredBys" />
							<span asp-validation-for="ReferredBy"></span>
						</div>
					</div>
					
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="AssignedToValue" asp-required="Model.LogisticsQuoteAssignedToValueRequired" />
						</div>
						<div class="input-name">
							<nop-select class="form-select" asp-for="AssignedToValue" asp-items="Model.AvailableAssignedTo" />
							<span asp-validation-for="AssignedToValue"></span>
						</div>
					</div>
				</div>
			</div>

		</div>

		<div class="col-md-6">
			<div class="card h-100">
				<div class="card-body">
					
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="Address" asp-required="Model.LogisticsQuoteAddressRequired" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="Address" html-attributes="@(new { placeholder = "Enter Address 1" })" />
							<span asp-validation-for="Address"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="Address2" asp-required="Model.LogisticsQuoteAddress2Required" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="Address2" html-attributes="@(new { placeholder = "Enter Address 2" })" />
							<span asp-validation-for="Address2"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="City" asp-required="Model.LogisticsQuoteCityRequired" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="City" html-attributes="@(new { placeholder = "Enter City" })" />
							<span asp-validation-for="City"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="State" asp-required="Model.LogisticsQuoteStateRequired" />
						</div>
						<div class="input-name">
							<nop-select class="form-select" asp-for="State" asp-items="Model.AvailableStates" />
							<span asp-validation-for="State"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="Zip" asp-required="Model.LogisticsQuoteZipRequired" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="Zip" />
							<span asp-validation-for="Zip"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="Region" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="Region" html-attributes="@(new { placeholder = "Enter Region / Province" })" />
							<span asp-validation-for="Region"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="Country" asp-required="Model.LogisticsQuoteCountryRequired" />
						</div>
						<div class="input-name">
							<nop-select class="form-select" asp-for="Country" asp-items="Model.AvailableCountries" />
							<span asp-validation-for="Country"></span>
						</div>
					</div>
					<div class="custom-form-group">
						<div class="label-name">
							<nop-label asp-for="Mobile" asp-required="Model.LogisticsQuoteMobileRequired" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="Mobile" />
							<span asp-validation-for="Mobile"></span>
						</div>
					</div>
					<div class="custom-form-group" style="display:none">
                        <div class="label-name">
                            <nop-label asp-for="Fax" asp-required="Model.LogisticsQuoteFaxRequired" />
                        </div>
                        <div class="input-name">
                            <nop-editor asp-for="Fax" />
                            <span asp-validation-for="Fax"></span>
                        </div>
                    </div>
					<div class="custom-form-group" style="display:none">
						<div class="label-name">
							<nop-label asp-for="Latitude" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="Latitude" />
							<span asp-validation-for="Latitude"></span>
						</div>
					</div>
					<div class="custom-form-group" style="display:none">
						<div class="label-name">
							<nop-label asp-for="Longitude" />
						</div>
						<div class="input-name">
							<nop-editor asp-for="Longitude" />
							<span asp-validation-for="Longitude"></span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

</div>

<div id="referral-add-new-record" class="modal fade" tabindex="-1" aria-labelledby="referral-add-new-record-title" style="display: none;">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="referral-add-new-record-title">@T("Admin.Common.AddRecord.Referral")</h4>
				<button type="button" class="close" id="close-referral-add-new-record" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
			</div>
			<div class="modal-body d-form">
				<div class="row">
					<div class="col-md-12">
						<div class="form-group row">
							<div class="col-md-12">
								<label class="col-form-label" for="ReferrerName">@T("Admin.Configuration.Settings.Referral.Fields.Name")</label>
								<nop-required />
							</div>
							<div class="col-md-12">
								<input type="text" id="ReferrerName" name="ReferrerName" class="form-control" />
								<div>
									<span style="color:red;" id="ReferrerName-validation"></span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" id="addReferrer" class="btn btn-primary">@T("Admin.Common.Save")</button>
			</div>
		</div>
	</div>
</div>

<script>

	commonPhoneNumber("#Phone1, #Phone2, #Mobile, #Fax");
	restrictToCityNameFormat("#City");
	enforceLowerCase("#Email");
	allowUniversalZip("#Zip");

	$(document).ready(function () {
		$("#ReferredBy").data("kendoDropDownList").ul.find("li:first").addClass("k-add-new-option");

		$("#@Html.IdFor(model => model.Country)").change(function () {
			var selectedItem = $(this).data("kendoDropDownList").value();
			var ddlStates = $("#@Html.IdFor(model => model.State)").data("kendoDropDownList");
			$.ajax({
				cache: false,
				type: "GET",
				url: "@(Url.Action("GetStatesByCountryId", "Country"))",
				data: {
					"countryId": selectedItem,
					"addSelectStateItem": "false"
				},
				success: function (data, textStatus, jqXHR) {
					var dataSource = ddlStates.dataSource;
					dataSource.data([]);
					$.each(data,
						function (id, option) {
							dataSource.add({
								text: option.name,
								value: option.id
							});
						});
					$("#State").data("kendoDropDownList").value(0);
				},
				error: function (jqXHR, textStatus, errorThrown) {
					$("#statesAlert").click();
				}
			});
		});
	
		$("#@Html.IdFor(model => model.CompanyId)").change(function () {
			const companyId = $(this).val();

			$("#AddToCustomerList").removeAttr("disabled");
			var ddlCustomers = $("#@Html.IdFor(model => model.CustomerId)").data("kendoDropDownList");

			$.ajax({
				cache: false,
				type: "GET",
				url: "@(Url.Action("GetCompanyDetailsById", "Company"))",
				data: {
					id: companyId,
				},
				success: function (data, textStatus, jqXHR) {
					if (data) {
						$('#@Html.IdFor(model => model.ShipperCompany)').val(data.Name);
						$("#@Html.IdFor(model => model.Address)").val(data.Address);
						$("#@Html.IdFor(model => model.Address2)").val(data.Address2);
						$("#@Html.IdFor(model => model.City)").val(data.City);
						$("#@Html.IdFor(model => model.State)").data("kendoDropDownList").value(data.StateProvinceId);
						$("#@Html.IdFor(model => model.Zip)").val(data.ZipCode);
						$("#@Html.IdFor(model => model.Country)").data("kendoDropDownList").value(data.CountryId);

						if(data.AccountType != null && (data.AccountType.toLowerCase() === "@LogisticsDefaults.PaymentOption.Billable.ToLower()" || 
						data.AccountType.toLowerCase() === "@LogisticsDefaults.PaymentOption.COD.ToLower()")){
							$('#@Html.IdFor(model => model.PaymentOption)').data("kendoDropDownList").value(data.AccountType);
						}
						else{
							$('#@Html.IdFor(model => model.PaymentOption)').data("kendoDropDownList").value("0");
						}

						$("#@Html.IdFor(model => model.PaymentOption)").trigger('change');

						var dataSource = ddlCustomers.dataSource;
						dataSource.data([]);
						$.each(data.CustomerList,
							function (id, option) {
								dataSource.add({
									text: option.Text,
									value: option.Value
								});
							});
						$("#@Html.IdFor(model => model.CustomerId)").data("kendoDropDownList").value(0);
						$("#@Html.IdFor(model => model.CustomerId)").trigger('change');

						percentageMargin = data.PercentagePriceMargin;
						$("#PercentagePriceMargin").val(data.PercentagePriceMargin);

						let estimatedCarrierRate = parseFloat($("#EstimatedCarrierRate").val()) || 0;
						$("#EstimatedCarrierPriceRate").val(roundDecimal(estimatedCarrierRate, 2));
						$("#EstimatedCustomerPrice").val(roundDecimal(estimatedCarrierRate / (1 - percentageMargin/100), 2));

						calculateTotalProfit();
					}
				},
				error: function (jqXHR, textStatus, errorThrown) {
				}
			});
		});

		$("#@Html.IdFor(model => model.CustomerId)").change(function () {
			const customerId = $(this).val();

			if (customerId == "0") {
				$("#AddToCustomerList").removeAttr("disabled");
			}
			else {
				$("#AddToCustomerList").attr("disabled", "disabled");
			}

			$.ajax({
				cache: false,
				type: "GET",
				url: "@(Url.Action("CustomerAutoFillData", "LogisticsQuote"))",
				data: {
					customerId: customerId,
				},
				success: function (data, textStatus, jqXHR) {
					if (data.result) {
						$("#@Html.IdFor(model => model.Email)").val(data.email);
						$("#@Html.IdFor(model => model.Phone1)").val(data.phone);
						$("#@Html.IdFor(model => model.Mobile)").val(data.mobile);
					}
				},
				error: function (jqXHR, textStatus, errorThrown) {

				}
			});
		});

		if ($("#CustomerId").val() == "0") {
			$("#AddToCustomerList").removeAttr("disabled");
		}
		else {
			$("#AddToCustomerList").attr("disabled", "disabled");
		}
	
		$('#CustomerId').change(function () {
			if ($(this).val() == "0") {
				$("#AddToCustomerList").removeAttr("disabled");
			}
			else {
				$("#AddToCustomerList").attr("disabled", "disabled");
			}
		});
	});

	let previousZipCode = {};

	const debounceFunc = debounce(fetchZipCodes, 500);

    function fetchZipCodes(field) {
		var zipCodeId = field.attr('id');
		var txtZipCode = $("#" + zipCodeId).val();

		let previousPostalCode = previousZipCode[zipCodeId];

		if (previousPostalCode == txtZipCode){
			return false;
		}

		previousZipCode[zipCodeId] = txtZipCode;

		if (txtZipCode.length === 5) {
			$("#"+ zipCodeId).prop('readonly', true);
			var postData = { zipCode: txtZipCode };
			addAntiForgeryToken(postData);
			$.ajax({
				cache: false,
				type: "GET",
				url: "@(Url.Action("GetLocationInfoUsingGoogleAPI", "LogisticsCommon"))",
				data: postData,
				success: function (response) {
					$("#"+ zipCodeId).prop('readonly', false);

					if (response.country != $("#Country").val()){

						$("#Latitude").val(0);
						$("#Longitude").val(0);

						return;
					}

					$("#City").val(response.city);
					$("#State").data("kendoDropDownList").value(response.state);
					//$("#Country").data("kendoDropDownList").value(response.country);
					$("#Latitude").val(response.latitude);
					$("#Longitude").val(response.longitude);
				},
				error: function (jqXHR, textStatus, errorThrown) {
					$("#"+ zipCodeId).prop('readonly', false);
				}
			});
		}
		else {
			$("#Latitude").val(0);
			$("#Longitude").val(0);

			$("#"+ zipCodeId).prop('readonly', false);
		}
    }

	$("#Zip").keyup(function () {
		debounceFunc($(this));
	});

	let referredByPreviousValue = $("#ReferredBy").val();

	$("#ReferredBy").change(function(){
		let value = $(this).val();
		if(value === "-1")
		{
			$("#referral-add-new-record").modal("show");
		}
		else{
			referredByPreviousValue = value;
		}
	});

	$("#close-referral-add-new-record").click(function () {
		$("#ReferrerName").val("");
		$("#ReferrerName-validation").text("");
		$("#ReferredBy").val(referredByPreviousValue);
		$("#ReferredBy").data("kendoDropDownList").value(referredByPreviousValue);
		$("#referral-add-new-record").modal("hide").attr('area-hidden', '');
	});

	$("#addReferrer").click(function(e){
		e.preventDefault();

		$("#ReferrerName-validation").text("");
		let name = $("#ReferrerName").val();
		if (name === null || name === undefined || name.trim() === "") {
			$("#ReferrerName-validation").text("@T("Admin.Referral.Fields.Name.Required")");
			return false;
		}

		var postData = {
			Name : name,
			Active : true
		}

		addAntiForgeryToken(postData);

		$.post("@Url.Action("AddRecord", "Referral")",postData, function (data, textStatus, jqXHR) {
			if (data){
				if(data.Status){
					$("#ReferrerName").val("");
					toastr.success('@T("Admin.Configuration.Settings.Referral.Add.Success")');

					$("#referral-add-new-record").modal("hide").attr('area-hidden', '');

					var formattedData = data.Records.map(function (item) {
						return {
							text: item.Text,
							value: item.Value
						};
					});

					var dropDown = $("#ReferredBy").data("kendoDropDownList");

					dropDown.setDataSource(new kendo.data.DataSource({
						data: formattedData
					}));

					// dropDown.select(0);
					dropDown.ul.find("li:first").addClass("k-add-new-option");

					if (data.referralName != "0"){
						referredByPreviousValue = data.referralName;
					}

					$("#ReferredBy").val(referredByPreviousValue);
					$("#ReferredBy").data("kendoDropDownList").value(referredByPreviousValue);
					$("#ReferredBy").trigger('change');
				}
				else if (data.Message){
					$("#ReferrerName-validation").text(data.Message);
				}
				else {
					display_nop_error(data);
				}
			}
			else{
				$("#ReferrerName").val("");
				$("#ReferrerName-validation").text("");
				$("#ReferredBy").val(referredByPreviousValue);
				$("#ReferredBy").data("kendoDropDownList").value(referredByPreviousValue);
				$("#referral-add-new-record").modal("hide").attr('area-hidden', '');
				$("#ReferredBy").trigger('change');
			}
		});
	});

	$("#ReferrerName").bind('keyup focusout',function(){
		let value = $(this).val();

		if (value === null || value === undefined || value.trim() === "") {
			$("#ReferrerName-validation").text("@T("Admin.Referral.Fields.Name.Required")");
		}
		else{
			$("#ReferrerName-validation").text("");
		}
	});

	$("#ReferredBy").change(function(){
		let referral = $(this).val();
		$(".referral-name").text("").closest("label").hide();

		if (referral == "0" || referral == ""){
			$(".referral-name").text("").closest("label").hide();
			arrayManager.removeItem("Value", "@((int)AccessorialType.Referral)");
		}
		else{
			$(".referral-name").text(referral).closest("label").show();
			arrayManager.restoreItem();
		}
	});

</script>