@model LogisticsQuoteModel
<div class="card detail-info-card d-card">
    <div class="card-header with-border clearfix">
        <div class="card-title">
            <i class="far fa-newspaper"></i>
            @T("Admin.InternalNotes")
        </div>
    </div>
    <div class="card-body">
        <div class="form-group row">
            <div class="col-md-12 custom-size-input-group">
                <div class="custom-label-box">
                    <nop-label asp-for="AddQuoteNoteMessage" />
                </div>
                <div class="custom-input-areabox">
                    <nop-textarea asp-for="AddQuoteNoteMessage" html-attributes="@(new { placeholder = "Enter Internal Notes" })" />
                    <span asp-validation-for="AddQuoteNoteMessage"></span>
                </div>
                <div class="custom-btn-area">
                    <button type="button" id="addQuoteNote" class="btn btn-primary">@T("Admin.LogisticsQuote.QuoteNotes.AddButton")</button>
                </div>
            </div>
            
        </div>
        <div class="card card-default d-datatable m-0">
            <div class="card-body">
                @await Html.PartialAsync("Table", new DataTablesModel
           {
               Name = "quotenotes-grid",
               UrlRead = new DataUrl("QuoteNotesSelect", "LogisticsQuote", new RouteValueDictionary { [nameof(Model.QuoteNoteSearchModel.LeadId)] = Model.QuoteNoteSearchModel.LeadId }),
               UrlDelete = new DataUrl("QuoteNoteDelete", "LogisticsQuote", new RouteValueDictionary { [nameof(Model.QuoteNoteSearchModel.LeadId)] = Model.QuoteNoteSearchModel.LeadId }),
               Length = Model.QuoteNoteSearchModel.PageSize,
               LengthMenu = Model.QuoteNoteSearchModel.AvailablePageSizes,
               ColumnCollection = new List<ColumnProperty>
                {
                new ColumnProperty(nameof(QuoteNoteModel.CreatedOn))
                {
                Title = T("Admin.LogisticsQuote.Fields.CreatedOn").Text,
                Width = "200",
                Render = new RenderDate()
                },
                new ColumnProperty(nameof(QuoteNoteModel.Note))
                {
                Title = T("Admin.LogisticsQuote.Fields.Note").Text,
                Encode = false
                },
                new ColumnProperty(nameof(QuoteNoteModel.Customer))
                {
                Title = T("Admin.LogisticsQuote.Fields.Customer.InternalNote").Text,
                Width = "200"
                },
                new ColumnProperty(nameof(QuoteNoteModel.Id))
                {
                Title = T("Admin.Common.Delete").Text,
                Width = "100",
                Render = new RenderCustom("renderColumnNotesDelete"),
                ClassName =  NopColumnClassDefaults.Button
                }
                }
           })
            </div>
        </div>
    </div>
</div>

<div id="quoteNote-delete-confirmation" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="quoteNote-delete-confirmation-title" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="quoteNotedelete-confirmation-title">@T("Admin.Common.AreYouSure")</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="form-horizontal">
                <div class="modal-body">
                    @T("Admin.Common.DeleteConfirmation")
                </div>
                <div class="modal-footer">
                    <span class="btn btn-default" data-dismiss="modal">@T("Admin.Common.NoCancel")</span>
                    <button type="submit" class="btn btn-danger float-right">@T("Admin.Common.Delete")</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $("#quotenotes-grid")
        .on("click", ".delete-quoteNote-link", function (e) {
            $("#quoteNote-delete-confirmation button[type=submit]").attr("name", $(this).attr("name"));
        });
</script>
<script asp-location="Footer">
    function renderColumnNotesDelete(data, type, row, meta) {
        return '<a name="delete-quoteNote-link-' + data + '" class="btn btn-default delete-quoteNote-link" data-toggle="modal" data-target="#quoteNote-delete-confirmation"><i class="far fa-trash-alt"></i>Delete</a>';
    }
</script>

<script>
    $(document).ready(function () {
        $('#addQuoteNote').click(function () {
            var quoteNoteMessage = $("#@Html.IdFor(model => model.AddQuoteNoteMessage)").val();
            if(!quoteNoteMessage || quoteNoteMessage.trim() == "") {
                let message = "@T("Admin.LogisticsQuote.QuoteNotes.Fields.Note.Validation")";
				var validationSpan = $('span[data-valmsg-for="AddQuoteNoteMessage"]');
				validationSpan.removeClass('field-validation-valid').addClass('field-validation-error').html(`<span id="AddQuoteNoteMessage-error" class="">${message}</span>`).show();
				return false;
			}
            else if(quoteNoteMessage.trim() != "" && quoteNoteMessage.trim().length > 1000){
                let message = "@T("Admin.LogisticsQuote.AllFields.Notes.MaxLength")";
                var validationSpan = $('span[data-valmsg-for="AddQuoteNoteMessage"]');
                validationSpan.removeClass('field-validation-valid').addClass('field-validation-error').html(`<span id="AddQuoteNoteMessage-error" class="">${message}</span>`).show();
                return false;
            }          

            var quoteNoteDisplayToCustomer =
                $("#@Html.IdFor(model => model.AddQuoteNoteDisplayToCustomer)").is(':checked');
            $('#addQuoteNote').attr('disabled', true);

            var postData = {
                DisplayToCustomer: quoteNoteDisplayToCustomer,
                message: quoteNoteMessage,
                leadId: '@Model.LeadId'
            };
            addAntiForgeryToken(postData);

            $.ajax({
                cache: false,
                type: "POST",
                url: "@(Url.Action("QuoteNoteAdd", "LogisticsQuote"))",
                data: postData,
                success: function (data, textStatus, jqXHR) {
                    if (data.Result) {
                        //reload grid
                        updateTable('#quotenotes-grid');

                        $("#@Html.IdFor(model => model.AddQuoteNoteMessage)").val("");
                        $("#@Html.IdFor(model => model.AddQuoteNoteDisplayToCustomer)").prop("checked", false);
                    } else {
                        //display errors if returned
                        display_nop_error(data);
                    }
                },
                complete: function (jqXHR, textStatus) {
                    $('#addQuoteNote').attr('disabled', false);
                }
            });
        });

        $("#AddQuoteNoteMessage").on('input', function () {
            let value = $(this).val();
            var validationSpan = $('span[data-valmsg-for="AddQuoteNoteMessage"]');

            if(!value || value.trim() == ""){
                validationSpan.show();
            }
            else{
                validationSpan.hide();
            }
        });
    });
</script>